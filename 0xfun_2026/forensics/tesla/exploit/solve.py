#!/usr/bin/env python3
"""
Tesla - 0xfun CTF
Category: Forensics (250 points, Medium)

Solution: Deobfuscate Flipper Zero BadUSB script and XOR decrypt hidden flag
"""
import re


def main():
    print("[*] Reading Tesla.sub...")

    # Read file and extract RAW_Data
    with open("Tesla.sub", "rb") as f:
        content = f.read()

    text = content.decode("latin1")
    lines = text.split("\n")

    binary_str = ""
    for line in lines:
        if "RAW_Data:" in line:
            binary_str = line.split("RAW_Data:")[1].strip()
            break

    # Remove spaces and decode binary to bytes
    binary_str = binary_str.replace(" ", "")

    decoded_bytes = bytearray()
    for i in range(0, len(binary_str), 8):
        byte = binary_str[i : i + 8]
        if len(byte) == 8:
            decoded_bytes.append(int(byte, 2))

    decoded = bytes(decoded_bytes).decode("latin1")
    print(f"[+] Decoded {len(decoded)} characters from binary")

    # Extract Ilc obfuscation variable
    match = re.search(r'set\s+"Il.c=([^"]+)"', decoded)
    if not match:
        print("[!] Could not find Ilc variable")
        return

    ilc = match.group(1)
    print(f"[+] Extracted Ilc variable (length: {len(ilc)})")

    # Deobfuscate using Ilc (replace %Il.c:~N,1% with ilc[N])
    pattern = r"%Il.c:~(\d+),1%"

    def replacer(match):
        pos = int(match.group(1))
        if pos < len(ilc):
            return ilc[pos]
        return match.group(0)

    deobf = re.sub(pattern, replacer, decoded)
    print("[+] Deobfuscated Ilc patterns")

    # Remove remaining obfuscated variables (%...%)
    cleaned = re.sub(r"%[^%]+%", "", deobf)
    print("[+] Removed remaining obfuscated variables")

    # Extract PowerShell string
    ps_match = re.search(r"GetBytes\('([^']+)'\)", cleaned)
    if not ps_match:
        print("[!] Could not find PowerShell string")
        return

    key_string = ps_match.group(1)
    print(f"[+] Found XOR key: '{key_string}'")

    # Extract hex from comment
    hex_match = re.search(r"::\s*([0-9a-fA-F]+)\s*::", cleaned)
    if not hex_match:
        print("[!] Could not find hex in comment")
        return

    hex_str = hex_match.group(1)
    hex_bytes = bytes.fromhex(hex_str)
    print(f"[+] Found hex in comment ({len(hex_bytes)} bytes)")

    # XOR decrypt with key
    key_bytes = key_string.encode("utf-8")
    flag = bytes(hex_bytes[i] ^ key_bytes[i % len(key_bytes)] for i in range(len(hex_bytes)))

    print(f"\n[+] FLAG: {flag.decode('latin1').strip()}")


if __name__ == "__main__":
    main()
