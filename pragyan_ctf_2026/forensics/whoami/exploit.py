#!/usr/bin/env python3
"""
whoami - Pragyan CTF 2026
Extracción y cracking de hash NTLMv2 desde PCAP

Flag: p_ctf{t.stark:Arcadia1451606400}

Uso:
  python3 exploit_whoami.py capture.pcap
"""
import subprocess
import datetime
import sys


def extract_ntlmv2_hashes(pcap):
    """Extrae hashes NTLMv2 del PCAP en formato hashcat 5600."""
    cmd = (
        f"tshark -r {pcap} -Y 'tcp.port == 445' -T fields "
        f"-e ntlmssp.auth.username -e ntlmssp.auth.domain "
        f"-e ntlmssp.ntlmserverchallenge -e ntlmssp.auth.ntresponse"
    )
    result = subprocess.run(cmd, shell=True, capture_output=True, text=True)

    hashes = []
    challenge = None
    for line in result.stdout.strip().split('\n'):
        if not line.strip():
            continue
        parts = line.split('\t')
        if len(parts) >= 3 and parts[2] and not parts[0]:
            challenge = parts[2]
        if len(parts) >= 4 and parts[0] and parts[3]:
            username = parts[0]
            domain = "" if parts[1] == "NULL" else parts[1]
            nt_response = parts[3]
            ntproofstr = nt_response[:32]
            blob = nt_response[32:]
            hashes.append(f"{username}::{domain}:{challenge}:{ntproofstr}:{blob}")

    return hashes


def generate_wordlist():
    """Genera wordlist [ProjectName][EpochTimestamp] cubriendo todo enero 2016."""
    projects = ['SuperHeroCallcentre', 'Terrabound', 'OceanMining', 'Arcadia']
    passwords = set()

    for proj in projects:
        # Todo enero 2016, cada hora
        for day in range(1, 32):
            for hour in range(24):
                dt = datetime.datetime(2016, 1, day, hour, 0, 0,
                                       tzinfo=datetime.timezone.utc)
                passwords.add(f'{proj}{int(dt.timestamp())}')

        # Jan 31 2016/2026, minuto a minuto
        for year in [2016, 2026]:
            for hour in range(24):
                for minute in range(60):
                    dt = datetime.datetime(year, 1, 31, hour, minute, 0,
                                           tzinfo=datetime.timezone.utc)
                    passwords.add(f'{proj}{int(dt.timestamp())}')

    return sorted(passwords)


def main():
    pcap = sys.argv[1] if len(sys.argv) > 1 else "capture.pcap"

    print("[*] Paso 1: Extrayendo hashes NTLMv2...")
    hashes = extract_ntlmv2_hashes(pcap)
    print(f"    {len(hashes)} hashes extraídos")

    hash_file = "/tmp/whoami_hashes.txt"
    with open(hash_file, 'w') as f:
        f.write('\n'.join(hashes) + '\n')

    print("[*] Paso 2: Generando wordlist...")
    passwords = generate_wordlist()
    wordlist_file = "/tmp/whoami_wordlist.txt"
    with open(wordlist_file, 'w') as f:
        f.write('\n'.join(passwords) + '\n')
    print(f"    {len(passwords)} contraseñas generadas")

    print("[*] Paso 3: Crackeando con hashcat (modo 5600)...")
    subprocess.run(
        f"hashcat -m 5600 {hash_file} {wordlist_file} --force -O --quiet",
        shell=True
    )

    print("\n[*] Resultados:")
    result = subprocess.run(
        f"hashcat -m 5600 {hash_file} --show",
        shell=True, capture_output=True, text=True
    )

    for line in result.stdout.strip().split('\n'):
        if line:
            parts = line.split(':')
            user = parts[0]
            password = parts[-1]
            print(f"    {user}: {password}")
            if 't.stark' in user.lower():
                print(f"\n[*] FLAG: p_ctf{{{user.lower()}:{password}}}")


if __name__ == "__main__":
    main()
